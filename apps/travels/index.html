<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Onur Varol's travel map">
    <meta name="author" content="Onur Varol">
    
    <title>Onur's Travel Journal</title>
    
    <link rel="stylesheet" type="text/css" href="css/style.css" />
    <script src="js/jquery-1.10.2.min.js" type="text/javascript"></script>
    <script src="js/underscore-min.js" type="text/javascript"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp"></script>
    <link rel="stylesheet" href="css/jquery.sliderTabs.css">
    <script src="js/jquery.sliderTabs.js"></script>

    <script type="text/javascript">

      var qs = (function(a) {
        if (a == "") return null;
        var b = {};
        for (var i = 0; i < a.length; ++i)
        {
            var p=a[i].split('=', 2);
            if (p.length == 1)
                b[p[0]] = "";
            else
                b[p[0]] = decodeURIComponent(p[1].replace(/\+/g, " "));
        }
        return b;
        })(window.location.search.substr(1).split('&'));
      //alert(qs['id'].replace("/", ""));

      function updateShareHref(travelId){

        if (typeof travelId == 'string' || travelId instanceof String){
          console.log(travelId);
          var temp = travelId.split('-');
          $.getScript("http://platform.twitter.com/widgets.js");
          $("#twitter-share-button").html('<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.onurvarol.com/apps/travels/index.html?id=' + travelId +'" data-text="Onur\'s travel journal -> ' + temp[1] + '" data-count="none" data-hashtags="travel" data-via="onurvarol" data-related="onurvarol">Tweet</a>');

          //$("#facebook-share-button").html('<div id="fb-share-button" class="fb-share-button" data-href="http://www.onurvarol.com/apps/travels/index.html?id=' + travelId + '" data-layout="button" style="vertical-align:top;zoom:1;*display:inline"></div>');

          $("#facebook-share-button").html('<fb:share-button href="http://www.onurvarol.com/apps/travels/index.html?id=' + travelId + '" type="button"></fb:share-button>');

          //var fb = document.getElementById("fb-share-button");
          //fb.setAttribute("data-href", "http://www.onurvarol.com/apps/travels/index.html?id=" + travelId);
          //$('.fb-share-button').attr('data-href', "http://www.onurvarol.com/apps/travels/index.html?id=" + travelId);
          console.log('updates');
        }
        else{
          $.getScript("http://platform.twitter.com/widgets.js");
          //$("#twitter-share-button").html('&nbsp;'); 
          $("#twitter-share-button").html('<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://www.onurvarol.com/apps/travels/index.html" data-text="Onur\'s travel journal" data-count="none" data-hashtags="travel" data-via="onurvarol" data-related="onurvarol">Tweet</a>');

          //$("#facebook-share-button").html('<div id="fb-share-button" class="fb-share-button" data-href="http://www.onurvarol.com/apps/travels/index.html" data-layout="button" style="vertical-align:top;zoom:1;*display:inline"></div>');
          $("#facebook-share-button").html('<fb:share-button href="http://www.onurvarol.com/apps/travels/index.html" type="button"></fb:share-button>');
        }
        $.ajaxSetup({ cache: true });
        $.getScript('//connect.facebook.net/en_US/sdk.js', function(){
          FB.init({
            appId: '139724208134',
            version: 'v2.3' // or v2.0, v2.1, v2.0
          });     
          FB.XFBML.parse();
        });
      }

      var directionsDisplay;
      var infowindow = new google.maps.InfoWindow();
      var markerOptions = {icon: "img/icon_marker.png",
                           visible: false};
      var directionsDisplayOptions = {preserveViewport: true,
                                      markerOptions: markerOptions};
      var directionsService = new google.maps.DirectionsService();
      var map;

      function createSlideBox(journey, map, camera){
        $( "#slides-box" ).empty();
        $( "#slides-box" ).show();
        var slides = journey['slides'];

        sliderDiv = "<div id='slider_journey'><ul>";
        sliderDiv += "<li><a href='#journey_start'></a></li>";
        contentDiv = "<div id='journey_start'>"+ "<span class='slide_title'>" + journey['name'] + "</span><br/>"
                    + "<span class='slide_content'>" + journey['info'] + "</span></div>";

        for(var i=0; i<slides.length; i++){
          sliderDiv += "<li><a href='#journey_" + i + "'></a></li>";
          contentDiv += "<div id='journey_" + i + "'>" + "<span class='slide_title'>" + slides[i]['title'] + 
                      "</span><br/>" + "<span class='slide_content'>" + slides[i]['content'] + "</span></div>";
        }
        sliderDiv += "</ul>" + contentDiv + "</div>";
        $('#slides-box').append(sliderDiv);

        $('#journey_start').on('panelChange', function() {
          var latlon = camera['journey_start']['lat-lon'];
          var center = new google.maps.LatLng(latlon[0], latlon[1]);

          map.setCenter(center);
          map.fitBounds(camera['journey_start']['bounds']);
          map.panToBounds(camera['journey_start']['bounds']);
        });

        for(var i=0; i<slides.length; i++){
          $('#journey_' + i).on('panelChange', slides[i], function(event) {
            //console.log(event.data);
            var latlon = event.data['lat-lon'];
            var center = new google.maps.LatLng(latlon[0], latlon[1]);
            map.setCenter(center);
            map.setZoom(event.data['zoom']);
          });
        }

        var demo = $("div#slider_journey").sliderTabs({
                      position: "top",
                      indicators: true,
                      panelArrows: true,
                      panelArrowsShowOnHover: true,
                      tabs: false,
                      classes: {
                          panel: 'slider_panel'
                      }
                    });
        //console.log(demo);
      }


      function drawLocation(location){
        var marker;
        var latlon = location['lat-lon'];
        marker = new google.maps.Marker({
                          icon: "img/icon_" + location['type'] + ".png",
                          position: new google.maps.LatLng(latlon[0], latlon[1]),
                          map: map
                        });

        google.maps.event.addListener(marker, 'click', (function(marker, place) {
                          return function() {
                            var caption = "<div style='width:300px;text-align:center;'>" + place['description'];
                            var sliderDiv = '<br/>';
                            var imgDiv = '';
                            if (place['img'].length > 1){
                                sliderDiv += "<div id='slider_" + location['id'] + "'><ul>";
                                for(var i=0; i<place['img'].length; i++){
                                  sliderDiv += "<li><a href='#" + location['id'] + "_" + i + "'></a></li>";
                                  imgDiv += "<div id='" + location['id'] + "_" + i + "'><img src='" + place['img'][i] + "'/></div>";
                                }
                                sliderDiv += "</ul>" + imgDiv + "</div>";
                            }
                            else if (place['img'].length == 1) {
                              sliderDiv += "<img src='" + place['img'][0] + "' height='200'/>";
                            }
                            else{
                              sliderDiv += '';
                            }
                            
                            caption += sliderDiv + "</div>";
                            infowindow.setContent(caption);
                            infowindow.open(map, marker);

                            var demo = $("div#slider_" + location['id']).sliderTabs({
                              position: "top",
                              indicators: true,
                              panelArrows: true,
                              panelArrowsShowOnHover: true,
                              tabs: false,
                              classes: {
                                panel: 'slider_panel'
                              }
                            });
                          }
                        })(marker, location));
      }

      function drawMap(travelId) {
          $( "#slides-box" ).hide();
          var travelJournal = $.parseJSON(localStorage.getItem('travelJournal'));
          for (var key in travelJournal['locations']){
            travelJournal['locations'][key]['id'] = key;
          }

          updateShareHref(travelId);
          if (typeof travelId == 'string' || travelId instanceof String)
          {
            //console.log(travelId);
            var temp = travelId.split('-');
            //console.log(temp);

            if (temp[0] == "conferences"){
              var locKey = travelJournal[temp[0]][temp[1]]["location"];
              //console.log(locKey);
              var location = travelJournal["locations"][locKey];

              var center = new google.maps.LatLng(location['lat-lon'][0], location['lat-lon'][1]);
              var mapOptions = {
                zoom: 14,
                center: center
              };
              map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
              drawLocation(location);

            } else if (temp[0] == "cities"){
              //console.log('cty');
              var lat = 0;
              var lng = 0;
              var city = travelJournal[temp[0]][temp[1]];
              var places = city['places'];

              for (var p=0; p<places.length; p++){
                var place = travelJournal["locations"][places[p]];
                var latlon = place["lat-lon"];
                lat = lat + latlon[0];
                lng = lng + latlon[1];
              }

              lat = lat / (1.0*places.length);
              lng = lng / (1.0*places.length);
              var center = new google.maps.LatLng(lat, lng);
              var mapOptions = {
                zoom: city['zoom'],
                center: center
              };
              map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);
              
              for (var p=0; p<places.length; p++){
                var place = travelJournal["locations"][places[p]];
                drawLocation(place);
              }

            } else if (temp[0] == "journeys"){
              //console.log('jrn');
              var journey = travelJournal[temp[0]][temp[1]];
              var slides = journey["slides"];

              var center = new google.maps.LatLng(35, 20);
              var mapOptions = {
                  zoom: 2,
                  center: center
              };
              map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

              var bounds = new google.maps.LatLngBounds();
              for (var s=0; s<slides.length; s++){
                var latlon = slides[s]["lat-lon"];
                loc = new google.maps.LatLng(latlon[0], latlon[1]);
                bounds.extend(loc);
              }

              var places = journey['places'];
              for (var p=0; p<places.length; p++){
                var place = travelJournal["locations"][places[p]];
                var latlon = place["lat-lon"];
                loc = new google.maps.LatLng(latlon[0], latlon[1]);
                bounds.extend(loc);
                drawLocation(place);
              }
              map.fitBounds(bounds);
              map.panToBounds(bounds);

              // TODO: Here create story-box for journey
              var camera = {'journey_start':{'lat-lon':latlon, 'bounds':bounds}};
              createSlideBox(journey, map, camera);

              directionsDisplay = new google.maps.DirectionsRenderer(directionsDisplayOptions);
              var waypts = [];
              for (var i = 0; i < places.length; i++) {
                var place = travelJournal["locations"][places[i]];

                var draw = true;
                if (i+1 < places.length){
                  var nextPlace = travelJournal["locations"][places[i+1]];
                  var dist = Math.abs(nextPlace['lat-lon'][0] - place['lat-lon'][0]) +  Math.abs(nextPlace['lat-lon'][1] - place['lat-lon'][1])
                  console.log(place['name'], nextPlace['name'], dist)
                  if (dist < 1.){
                    draw = false;
                  }
                }

                if(draw){
                  waypts.push({
                    location:place['location'],
                    stopover:true});
                }
              }
              console.log(waypts);

              var request = {
                origin: travelJournal["locations"][places[0]]['location'],
                destination: travelJournal["locations"][places[places.length-1]]['location'],
                waypoints: waypts,
                optimizeWaypoints: false,
                travelMode: google.maps.TravelMode.DRIVING
              };

              directionsService.route(request, function(response, status) {
                if (status == google.maps.DirectionsStatus.OK) {
                  directionsDisplay.setDirections(response);    
                }
              });
              directionsDisplay.setMap(map);

            } else {
              console.log('none');
              drawMap();
            }

          }
          else{
            // Draw all locations on map
            var center = new google.maps.LatLng(35, 20);
              var mapOptions = {
                zoom: 2,
                center: center
            };
            map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

            _.each(travelJournal['locations'], drawLocation);
          }
      }

      $(document).ready(function () {
          $( "#slides-box" ).hide();

          $(".category-header").hover(function () {
              $(this).animate({ opacity: "0.5" });
          }
          ,function () {
              $(this).animate({ opacity: "1" });
          }).click(function () {
              var ad = $(this).attr("id").replace("head", "");
              $(".category-content").slideUp("slow");
              if ($("#tail" + ad).css("display") == 'none')
                  $("#tail" + ad).slideToggle("slow");
          });
          $(".category-content").slideToggle();

          var response = $.ajax({ type: 'GET',
                                  url: 'travel_journal.json',
                                  dataType: 'text',
                                  success: function(data) {
                                    udata = data;
                                  },
                                  async: false
                                }).responseText;

          //$.ajax({async: true})
          var travelJournal = $.parseJSON(response);
          for (var key in travelJournal['locations']){
            travelJournal['locations'][key]['id'] = key;
          }

          if (localStorage.getItem('travelJournal') != null) {
            localStorage.removeItem('travelJournal');
          }
          localStorage.setItem('travelJournal', response);
          console.log($.parseJSON(localStorage.getItem('travelJournal')));


          function loadPanel(data){

            function addMapItem(mapItem, itemId, container){
              var itemBox = '<div class="map-item" id="' + itemId + '">';
              itemBox += '<span class="travel_name">' + mapItem['name'] + '</span>&nbsp'; 
              itemBox += '</div>';
              $(container).append(itemBox);
              $("#" + itemId).val(itemId);
            };

            for (var key in travelJournal['conferences']){
              addMapItem(travelJournal['conferences'][key], 'conferences-'+key, '#tail-conference-container');
            }

            for (var key in travelJournal['journeys']){
              addMapItem(travelJournal['journeys'][key], 'journeys-'+key, '#tail-journey-container');
            }

            for (var key in travelJournal['cities']){
              addMapItem(travelJournal['cities'][key], 'cities-'+key, '#tail-city-container');
            }

            $('body').on('click', '.map-item', function(event){
                var tid = $(this).val();
                drawMap(tid);
            });
          }
          loadPanel(travelJournal);


          if (qs == null){
            google.maps.event.addDomListener(window, 'load', drawMap);
          }
          else{
            drawMap(qs['id'].replace("/", ""));
          }
          updateShareHref();
      });
    </script>

    <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-7399107-2']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
    </script>

  </head>
  <body>
    <div id="fb-root"></div>
    <script>(function(d, s, id) {
      var js, fjs = d.getElementsByTagName(s)[0];
      if (d.getElementById(id)) return;
      js = d.createElement(s); js.id = id;
      js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.3&appId=139724208134";
      fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>

    <div id="slides-box"></div>

    <div id="travels-box">
      <table>
        <tr>
          <td>Onur's Travel Journal</td>
          <td>
            <div id="twitter-share-button"></div>
            <div id="facebook-share-button"></div>
          </td>
        </tr>
      </table>
        
        <!--
        <a href="https://twitter.com/share" id="twitter-share-button" class="twitter-share-button" data-url="www.onurvarol.com/apps/travels/index.html" data-text="Onur's travel journal" data-via="onurvarol" data-related="onurvarol" data-count="none" data-hashtags="travel">Tweet</a>
        <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
        
        <div id="fb-share-button" class="fb-share-button" data-href="http://www.onurvarol.com/apps/travels/index.html" data-layout="button" style="vertical-align:top;zoom:1;*display:inline"></div>
        -->
      <hr>
      <button class="button" onclick="drawMap()">Load all</button>
      <div id="travels-content">
        <div class="category-header" id="head-journey-container">Journeys</div>
        <div class="category-content" id="tail-journey-container"></div>

        <div class="category-header" id="head-city-container">Cities</div>
        <div class="category-content" id="tail-city-container"></div>

        <div class="category-header" id="head-conference-container">Conferences</div>
        <div class="category-content" id="tail-conference-container"></div>

      </div>
    </div>
    <div id="map-canvas"></div>
  </body>
</html>